---
- name: Check and apply RDS pending maintenance with scheduled time and email alerts
  hosts: localhost
  gather_facts: false

  vars:
    rds_instance_id: "your-rds-instance-id"
    aws_region: "your-aws-region"
    email_recipients: "recipient@example.com"
    email_sender: "sender@example.com"
    email_smtp_server: "smtp.example.com"
    email_smtp_port: 587
    email_subject_prefix: "[RDS Maintenance Notification]"
    scheduled_time: "2024-08-19 02:45:00"  # Set the scheduled time in UTC

  tasks:
    - name: Check for pending maintenance actions
      aws_rds_info:
        db_instance_identifier: "{{ rds_instance_id }}"
        region: "{{ aws_region }}"
      register: rds_info

    - name: Extract pending maintenance actions
      set_fact:
        pending_maintenance: "{{ rds_info.db_instances[0].pending_modified_values | default([]) }}"

    - name: Send email alert before applying maintenance
      mail:
        host: "{{ email_smtp_server }}"
        port: "{{ email_smtp_port }}"
        from: "{{ email_sender }}"
        to: "{{ email_recipients }}"
        subject: "{{ email_subject_prefix }} Pending RDS Maintenance on {{ rds_instance_id }}"
        body: |
          The following pending maintenance actions were found for RDS instance {{ rds_instance_id }}:
          {{ pending_maintenance | to_nice_json }}
          
          The maintenance is scheduled to be applied at {{ scheduled_time }} (UTC).
      when: pending_maintenance | length > 0

    - name: Wait until the scheduled time before applying maintenance
      when: pending_maintenance | length > 0
      wait_for:
        timeout: "{{ (ansible_date_time.iso8601 | to_datetime('%Y-%m-%dT%H:%M:%SZ') | diff(scheduled_time | to_datetime('%Y-%m-%d %H:%M:%S'))).total_seconds() | int }}"
        state: present
      delegate_to: localhost

    - name: Apply pending maintenance if available
      when: pending_maintenance | length > 0
      aws_rds:
        db_instance_identifier: "{{ rds_instance_id }}"
        apply_immediately: yes
      register: rds_apply

    - name: Send email alert after applying maintenance
      mail:
        host: "{{ email_smtp_server }}"
        port: "{{ email_smtp_port }}"
        from: "{{ email_sender }}"
        to: "{{ email_recipients }}"
        subject: "{{ email_subject_prefix }} RDS Maintenance Applied on {{ rds_instance_id }}"
        body: |
          The pending maintenance actions have been successfully applied to RDS instance {{ rds_instance_id }}.
          
          Maintenance Details:
          {{ rds_apply | to_nice_json }}
      when: pending_maintenance | length > 0

      https://www.udemy.com/course/100-days-of-code/learn/lecture/17824302#overview
